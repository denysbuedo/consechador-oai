<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Red de Repositorios Institucionales</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        header {
            background: #004b8d;
            color: white;
            padding: 1rem 2rem;
        }
        header h1 {
            margin: 0;
            font-size: 1.4rem;
        }
        main {
            padding: 1rem 2rem;
        }
        .search-panel, .stats-panel, .results-panel {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        label {
            display: block;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
        input, select {
            width: 100%;
            padding: 0.4rem;
            margin-top: 0.2rem;
            box-sizing: border-box;
        }
        button {
            margin-top: 0.8rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            background: #004b8d;
            color: white;
            cursor: pointer;
        }
        button:disabled {
            opacity: 0.6;
            cursor: wait;
        }
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.5rem 1rem;
        }
        .result-item {
            border-bottom: 1px solid #eee;
            padding: 0.5rem 0;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-title {
            font-weight: 600;
            margin: 0;
        }
        .result-meta {
            font-size: 0.8rem;
            color: #555;
        }
        .badge {
            display: inline-block;
            background: #e0e7ff;
            color: #1d2a5f;
            border-radius: 999px;
            padding: 0.1rem 0.6rem;
            font-size: 0.75rem;
            margin-right: 0.25rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }
        .stats-card {
            background: #fafafa;
            border-radius: 6px;
            padding: 0.5rem 0.7rem;
            border: 1px solid #e2e2e2;
            max-height: 200px;
            overflow-y: auto;
        }
        .stats-card h3 {
            margin-top: 0;
            font-size: 0.95rem;
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }
        .pagination {
            margin-top: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
<header>
    <h1>Buscador | Red de Repositorios Institucionales</h1>
</header>
<main>
    <section class="search-panel">
        <h2>Búsqueda</h2>
        <label>
            Texto libre
            <input type="text" id="q" placeholder="Título, autor, palabra clave...">
        </label>

        <div class="filters">
            <div>
                <label>
                    Tipo de documento
                    <input type="text" id="type" placeholder="Artículo, Tesis...">
                </label>
            </div>
            <div>
                <label>
                    Repositorio
                    <select id="repository">
                        <option value="">(Todos)</option>
                        <option value="Omeka UH Scriptorium">UH</option>
                        <option value="DSpace UCLV">UCLV</option>
                    </select>
                </label>
            </div>
            <div>
                <label>
                    Año desde
                    <input type="number" id="year_from" min="1000" max="9999">
                </label>
            </div>
            <div>
                <label>
                    Año hasta
                    <input type="number" id="year_to" min="1000" max="9999">
                </label>
            </div>
        </div>

        <button id="searchBtn">Buscar</button>

        <div class="pagination">
            <button id="prevPageBtn">◀ Anterior</button>
            <span id="pageInfo">Página 1</span>
            <button id="nextPageBtn">Siguiente ▶</button>
        </div>
    </section>

    <section class="results-panel">
        <h2>Resultados</h2>
        <div id="results"></div>
    </section>

    <section class="stats-panel">
        <h2>Estadísticas</h2>
        <div class="stats-grid">
            <div class="stats-card">
                <h3>Por repositorio</h3>
                <div id="stats_repo"></div>
            </div>
            <div class="stats-card">
                <h3>Por tipo de documento</h3>
                <div id="stats_type"></div>
            </div>
            <div class="stats-card">
                <h3>Por año de publicación</h3>
                <div id="stats_year"></div>
            </div>
        </div>
    </section>
</main>

<script>
    const apiBase = window.location.origin;

    let currentPage = 1;
    const pageSize = 20;

    async function fetchStats() {
        try {
            const res = await fetch(`${apiBase}/stats/content`);
            const data = await res.json();
            renderStats(data);
        } catch (e) {
            console.error("Error cargando estadísticas", e);
        }
    }

    function renderStats(data) {
        const repoDiv = document.getElementById("stats_repo");
        const typeDiv = document.getElementById("stats_type");
        const yearDiv = document.getElementById("stats_year");

        repoDiv.innerHTML = "";
        (data.by_repository || []).forEach(row => {
            const div = document.createElement("div");
            div.className = "stats-row";
            div.innerHTML = `<span>${row.repository}</span><span>${row.count}</span>`;
            repoDiv.appendChild(div);
        });

        typeDiv.innerHTML = "";
        (data.by_type || []).forEach(row => {
            const div = document.createElement("div");
            div.className = "stats-row";
            div.innerHTML = `<span>${row.type || "(Sin tipo)"}</span><span>${row.count}</span>`;
            typeDiv.appendChild(div);
        });

        yearDiv.innerHTML = "";
        (data.by_year || []).forEach(row => {
            const div = document.createElement("div");
            div.className = "stats-row";
            div.innerHTML = `<span>${row.year}</span><span>${row.count}</span>`;
            yearDiv.appendChild(div);
        });
    }

    async function doSearch() {
        const btn = document.getElementById("searchBtn");
        btn.disabled = true;

        const q = document.getElementById("q").value.trim();
        const type = document.getElementById("type").value.trim();
        const repository = document.getElementById("repository").value;
        const year_from = document.getElementById("year_from").value;
        const year_to = document.getElementById("year_to").value;

        const params = new URLSearchParams();
        if (q) params.append("q", q);
        if (type) params.append("type", type);
        if (repository) params.append("repository", repository);
        if (year_from) params.append("year_from", year_from);
        if (year_to) params.append("year_to", year_to);
        params.append("page", currentPage);
        params.append("page_size", pageSize);

        try {
            const res = await fetch(`${apiBase}/search/advanced?` + params.toString());
            const data = await res.json();
            renderResults(data);
        } catch (e) {
            console.error("Error en búsqueda", e);
        } finally {
            btn.disabled = false;
        }
    }

    function renderResults(items) {
        const container = document.getElementById("results");
        const pageInfo = document.getElementById("pageInfo");
        pageInfo.textContent = `Página ${currentPage}`;

        container.innerHTML = "";
        if (!items || items.length === 0) {
            container.textContent = "Sin resultados para los filtros seleccionados.";
            return;
        }

        items.forEach(r => {
            const div = document.createElement("div");
            div.className = "result-item";

            const title = document.createElement("p");
            title.className = "result-title";

            if (r.url_landing_page) {
                title.innerHTML = `<a href="${r.url_landing_page}" target="_blank" rel="noopener">${r.title}</a>`;
            } else {
                title.textContent = r.title;
            }

            const meta = document.createElement("p");
            meta.className = "result-meta";
            const year = r.date_issued ? r.date_issued.substring(0, 4) : "";
            meta.textContent = [
                r.authors && r.authors.length ? r.authors.join("; ") : "",
                r.institution || "",
                r.repository || "",
                year
            ].filter(Boolean).join(" | ");

            const badges = document.createElement("div");
            if (r.type) {
                const b = document.createElement("span");
                b.className = "badge";
                b.textContent = r.type;
                badges.appendChild(b);
            }
            (r.keywords || []).slice(0, 5).forEach(k => {
                const b = document.createElement("span");
                b.className = "badge";
                b.textContent = k;
                badges.appendChild(b);
            });

            div.appendChild(title);
            div.appendChild(meta);
            div.appendChild(badges);
            container.appendChild(div);
        });
    }

    document.getElementById("searchBtn").addEventListener("click", () => {
        currentPage = 1;
        doSearch();
    });

    document.getElementById("prevPageBtn").addEventListener("click", () => {
        if (currentPage > 1) {
            currentPage -= 1;
            doSearch();
        }
    });

    document.getElementById("nextPageBtn").addEventListener("click", () => {
        currentPage += 1;
        doSearch();
    });

    // Cargar stats y primera búsqueda en blanco
    fetchStats();
    doSearch();
</script>
</body>
</html>
